<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
	<title>Upload an image</title>
	<link href="css/dialog.css" rel="stylesheet" type="text/css">
</head>
<body>

	<form class="form-inline" id="upl" name="upl" action="/uploadImg" method="post" enctype="multipart/form-data" target="upload_target" onsubmit="upload()">
		
		<div id="upload_in_progress" class="upload_infobar"><img src="img/spinner.gif" width="16" height="16" class="spinner">Upload in progress&hellip; <div id="upload_additional_info"></div></div>
		<div id="upload_infobar" class="upload_infobar"></div>	
		
		<p id="upload_form_container">
			<input id="uploader" name="userfile" type="file" class="FileBox" onChange="upload()">
		</p>
	</form>

	<iframe id="upload_target" name="upload_target" src="ci/index.php?blank"></iframe>
	<script type="text/javascript">

		var upload = function(){
			document.getElementById('upl').submit();
			evImagesDialog.inProgress();
		}

		var evImagesDialog = {

			inProgress : function() {
				document.getElementById("upload_infobar").style.display = 'none';
				document.getElementById("upload_additional_info").innerHTML = '';
				document.getElementById("upload_form_container").style.display = 'none';
				document.getElementById("upload_in_progress").style.display = 'block';
			},
			uploadFinish : function(result) {
				if (result.resultCode == 'failed')
				{
					document.getElementById("upload_in_progress").style.display = 'none';
					document.getElementById("upload_infobar").style.display = 'block';
					document.getElementById("upload_infobar").innerHTML = result.result;
					document.getElementById("upload_form_container").style.display = 'block';
				}
				else
				{
					document.getElementById("upload_in_progress").style.display = 'none';
					document.getElementById("upload_infobar").style.display = 'block';
					document.getElementById("upload_infobar").innerHTML = 'Upload Complete';
					
					var w = this.getWin();
					tinymce = w.tinymce;
				
					tinymce.EditorManager.activeEditor.insertContent('<img src="' + result.filename +'">');
					
					this.close();
				}
			},

			getWin : function() {
				return (!window.frameElement && window.dialogArguments) || opener || parent || top;
			},

			close : function() {
				var t = this;

				// To avoid domain relaxing issue in Opera
				function close() {
					tinymce.EditorManager.activeEditor.windowManager.close(window);
					tinymce = tinyMCE = t.editor = t.params = t.dom = t.dom.doc = null; // Cleanup
				};

				if (tinymce.isOpera)
					this.getWin().setTimeout(close, 0);
				else
					close();
			}

		};
	</script>
</body>
</html>